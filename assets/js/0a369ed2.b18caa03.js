"use strict";(self.webpackChunkpine_docs=self.webpackChunkpine_docs||[]).push([[4945],{3926:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>o,toc:()=>l});var t=i(4848),r=i(8453);const s={sidebar_position:3},a="Bind",o={id:"Guide - Advanced/bind",title:"Bind",description:"You may have seen the Bind example in the landing page or in the basics section. This is just a very simple helper function that validates that some of the properties of the request body, params or query match the expected type you specify.",source:"@site/docs/Guide - Advanced/bind.md",sourceDirName:"Guide - Advanced",slug:"/Guide - Advanced/bind",permalink:"/docs/Guide - Advanced/bind",draft:!1,unlisted:!1,editUrl:"https://github.com/BryanMwangi/pine-docs/blob/main/docs/Guide - Advanced/bind.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"Routing",permalink:"/docs/Guide - Advanced/routing"}},d={},l=[{value:"BindJSON",id:"bindjson",level:2},{value:"bindData",id:"binddata",level:3},{value:"isZeroValue",id:"iszerovalue",level:3},{value:"BindParam",id:"bindparam",level:2},{value:"BindQuery",id:"bindquery",level:2},{value:"bind",id:"bind-1",level:3}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"bind",children:"Bind"})}),"\n",(0,t.jsxs)(n.p,{children:["You may have seen the ",(0,t.jsx)(n.code,{children:"Bind"})," example in the landing page or in ",(0,t.jsx)(n.a,{href:"/docs/Guide%20-%20Basics/ctx#bindjson",children:"the basics section"}),". This is just a very simple helper function that validates that some of the properties of the request body, params or query match the expected type you specify."]}),"\n",(0,t.jsxs)(n.p,{children:["I had to implement my own way of validating the fields used by ",(0,t.jsx)(n.code,{children:"BindJSON"}),", ",(0,t.jsx)(n.code,{children:"BindParam"})," and ",(0,t.jsx)(n.code,{children:"BindQuery"})," and if you find yourself needing more sophisticated methods of implementing validations, here are some packages that you can use:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/go-playground/validator",children:"github.com/go-playground/validator"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/go-ozzo/ozzo-validation",children:"github.com/go-ozzo/ozzo-validation"})}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Feel free to use whatever package you wish."}),"\n",(0,t.jsx)(n.admonition,{title:"Experimental",type:"caution",children:(0,t.jsx)(n.p,{children:"This API and its features are experimental and may be updated soon."})}),"\n",(0,t.jsx)(n.h2,{id:"bindjson",children:"BindJSON"}),"\n",(0,t.jsx)(n.p,{children:"BindJSON binds the request body to the given interface. You can use this method to validate the the request body before processing the request."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"func (c *Ctx) BindJSON(v interface{}) error\n"})}),"\n",(0,t.jsx)(n.p,{children:"Let us see how it works under the hood."}),"\n",(0,t.jsxs)(n.p,{children:["First, we use the ",(0,t.jsx)(n.a,{href:"https://pkg.go.dev/encoding/json#NewDecoder",children:"json.NewDecoder"})," to decode the request body into the given interface. Then we call an internal function ",(0,t.jsx)(n.code,{children:"bindData"})," that takes the resulting output and checks for non-zero values. If some of the values are zero or empty strings, it would mean that the request body did not satisfy the requirements of the specified interface."]}),"\n",(0,t.jsx)(n.h3,{id:"binddata",children:"bindData"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"func bindData(destination interface{}) error\n"})}),"\n",(0,t.jsx)(n.p,{children:"Here is the full implementation of bindData:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"func bindData(destination interface{}) error {\n    v := reflect.ValueOf(destination)\n    if v.Kind() == reflect.Ptr {\n      v = v.Elem()\n    }\n    // we can check if the value is a struct or a slice\n    if v.Kind() == reflect.Struct {\n      for i := 0; i < v.NumField(); i++ {\n        field := v.Field(i)\n        if isZeroValue(field) {\n          return ErrValidation\n        }\n      }\n    }\n    if v.Kind() == reflect.Slice {\n      length := v.Len()\n      for i := 0; i < length; i++ {\n        if isZeroValue(v.Index(i)) {\n          return ErrValidation\n        }\n      }\n    }\n    return nil\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The function leverages Go's in built ",(0,t.jsx)(n.a,{href:"https://pkg.go.dev/reflect",children:"reflect"})," package to inspect and validate the data in the interface."]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Handling Pointers:\nThe function accepts ",(0,t.jsx)(n.code,{children:"destination"})," which could be of any data type as an argument.First it checks if the destination is a pointer. It then ",(0,t.jsx)(n.a,{href:"https://stackoverflow.com/a/27084475/22594767",children:"dereferences"})," the pointer to access the underlying value which in this case will be obtained by calling the ",(0,t.jsx)(n.code,{children:"v.Elem()"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Handling Structs and Slices:\nAs of now, we handle JSON objects or arrays as defined in the ",(0,t.jsx)(n.a,{href:"https://www.json.org/json-en.html",children:"json standard"}),". How we do that:"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"For JSON objects, in this case, the equivalent of a struct, we loop over all the fields of the struct and check if they are non-zero."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"For JSON arrays, we loop over all the elements of the array or slice and check if they are non-zero."}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"iszerovalue",children:"isZeroValue"}),"\n",(0,t.jsx)(n.p,{children:"Let us demystify the isZeroValue function. It is used to check if the value is zero or empty string. It returns a boolean value; true if the value is zero or empty string, false otherwise."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"func isZeroValue(val reflect.Value) bool\n"})}),"\n",(0,t.jsx)(n.p,{children:"Within isZerorValue, if there are nested structs or slices, we recursively call the function to check if the value is zero or empty string."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"case reflect.Slice, reflect.Array:\n  // For slices and arrays, check each element\n  if val.Len() == 0 {\n    return true\n  }\n  for i := 0; i < val.Len(); i++ {\n    if isZeroValue(val.Index(i)) {\n      return true\n    }\n  }\nreturn false\n"})}),"\n",(0,t.jsx)(n.p,{children:"There is no known recursion depth limit as of now, however, if you encounter such a scenario, please open an issue and I will look into it."}),"\n",(0,t.jsx)(n.admonition,{title:"Known Limitation",type:"caution",children:(0,t.jsx)(n.p,{children:"Currently, BindJSON only supports JSON objects and arrays. If you wish to support other data types, please open an issue and I will look into it."})}),"\n",(0,t.jsx)(n.h2,{id:"bindparam",children:"BindParam"}),"\n",(0,t.jsx)(n.p,{children:"Validates the request params and binds them to the given interface."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"func (c *Ctx) BindParam(key string, v interface{}) error\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Under the hood it utilizes the ",(0,t.jsx)(n.code,{children:"bind"})," function to validate the request params."]}),"\n",(0,t.jsx)(n.h2,{id:"bindquery",children:"BindQuery"}),"\n",(0,t.jsx)(n.p,{children:"Validates the request query and binds them to the given interface."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"func (c *Ctx) BindQuery(key string, v interface{}) error\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Under the hood it utilizes the ",(0,t.jsx)(n.code,{children:"bind"})," function to validate the request query."]}),"\n",(0,t.jsx)(n.h3,{id:"bind-1",children:"bind"}),"\n",(0,t.jsx)(n.p,{children:"The bind function is used to validate the request query or params. It requires the input in this case is the key of the param or query and the destination is the value of the param or query."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"func bind(input string, destination interface{}) error\n"})}),"\n",(0,t.jsx)(n.p,{children:"Here is the full implementation of the bind function:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"func bind(input string, destination interface{}) error {\n  // reflect the type and value of the destination\n  typ := reflect.TypeOf(destination)\n  val := reflect.ValueOf(destination)\n\n  if typ.Kind() != reflect.Ptr {\n    return ErrPtr\n  }\n\n  // Dereference pointer type to assign value\n  val = reflect.Indirect(val)\n\n  switch val.Kind() {\n  case reflect.String:\n    val.SetString(input)\n  case reflect.Int, reflect.Int64:\n    parsed, err := strconv.ParseInt(input, 10, 64)\n    if err != nil {\n      return ErrConvert\n    }\n    val.SetInt(parsed)\n  case reflect.Float64, reflect.Float32:\n    parsed, err := strconv.ParseFloat(input, 64)\n    if err != nil {\n      return ErrConvert\n    }\n    val.SetFloat(parsed)\n  case reflect.Bool:\n    parsed, err := strconv.ParseBool(input)\n    if err != nil {\n      return ErrConvert\n    }\n    val.SetBool(parsed)\n  default:\n    return ErrType\n  }\n  return nil\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"Here are the steps that bind takes:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Reflection of the destination:\nThe function leverages Go's in built ",(0,t.jsx)(n.a,{href:"https://pkg.go.dev/reflect",children:"reflect"})," package to inspect and validate the data in the interface. It accepts ",(0,t.jsx)(n.code,{children:"destination"})," which could be of any data type as an argument."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Check for pointer:\nThe function checks if ",(0,t.jsx)(n.code,{children:"destination"})," is a pointer. This is important because it can only assign values to pointers that can be ",(0,t.jsx)(n.a,{href:"https://stackoverflow.com/a/27084475/22594767",children:"dereferenced"})," to the underlying types.\nIf the destination is not a pointer, it returns an error."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Dereference pointer:\nDereferencing the pointer is done by calling the ",(0,t.jsx)(n.code,{children:"reflect.Indirect"})," function. This makes sure it works with the actual underlying type."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Check for supported types:\nThe function checks if the underlying type of the destination is one of the following:"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"String"}),"\n",(0,t.jsx)(n.li,{children:"Int"}),"\n",(0,t.jsx)(n.li,{children:"Int64"}),"\n",(0,t.jsx)(n.li,{children:"Float64"}),"\n",(0,t.jsx)(n.li,{children:"Float32"}),"\n",(0,t.jsx)(n.li,{children:"Bool"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"If the underlying type is not one of the above, it returns an error. More types will be added in the future."}),"\n",(0,t.jsxs)(n.ol,{start:"5",children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Parse the input:\nAfter checking for the supported types, the function parses the input string into the underlying type. This is done using the ",(0,t.jsx)(n.code,{children:"strconv"})," package."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Assign the value:\nFinally, the function assigns the parsed value to the destination."}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>o});var t=i(6540);const r={},s=t.createContext(r);function a(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);