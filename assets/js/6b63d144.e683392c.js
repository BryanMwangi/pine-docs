"use strict";(self.webpackChunkpine_docs=self.webpackChunkpine_docs||[]).push([[8827],{8042:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>r,contentTitle:()=>a,default:()=>d,frontMatter:()=>i,metadata:()=>c,toc:()=>l});var o=t(4848),s=t(8453);const i={sidebar_position:8},a="WebSockets",c={id:"Guide - Basics/websockets",title:"WebSockets",description:"Pine brings websocket support out of the box. I did not have time to implement a custom solution for websockets and instead had to use the package gorilla/websocket",source:"@site/docs/Guide - Basics/websockets.md",sourceDirName:"Guide - Basics",slug:"/Guide - Basics/websockets",permalink:"/pine-docs/docs/Guide - Basics/websockets",draft:!1,unlisted:!1,editUrl:"https://github.com/BryanMwangi/pine-docs/blob/main/docs/Guide - Basics/websockets.md",tags:[],version:"current",sidebarPosition:8,frontMatter:{sidebar_position:8},sidebar:"tutorialSidebar",previous:{title:"Logger",permalink:"/pine-docs/docs/Guide - Basics/logger"},next:{title:"Middlewares",permalink:"/pine-docs/docs/category/middlewares"}},r={},l=[{value:"How to use",id:"how-to-use",level:2},{value:"New",id:"new",level:3},{value:"Conn",id:"conn",level:3},{value:"WatchFile",id:"watchfile",level:3},{value:"Example",id:"example",level:4}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"websockets",children:"WebSockets"})}),"\n",(0,o.jsxs)(n.p,{children:["Pine brings websocket support out of the box. I did not have time to implement a custom solution for websockets and instead had to use the package ",(0,o.jsx)(n.a,{href:"https://github.com/gorilla/websocket",children:"gorilla/websocket"})]}),"\n",(0,o.jsx)(n.p,{children:"The reason for going with gorilla websocket is because it is popular and well tested. As you have noticed by now, Pine is most entirely built from the ground up but websocket is our only exception for using external packages."}),"\n",(0,o.jsx)(n.h2,{id:"how-to-use",children:"How to use"}),"\n",(0,o.jsx)(n.p,{children:"To use our implementation of websockets, you will need to use the websocket as a Pine handler. This is because each connection instance is handled independently."}),"\n",(0,o.jsx)(n.p,{children:"This may change in future versions as I hear feedback from you guys."}),"\n",(0,o.jsx)(n.h3,{id:"new",children:"New"}),"\n",(0,o.jsx)(n.p,{children:"The new function is called to open a new websocket connection and it returns a pine handler"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:"func New(handler func(conn *Conn, ctx *pine.Ctx), config ...Config) pine.Handler\n"})}),"\n",(0,o.jsx)(n.p,{children:"What this allows you to do, is you can attach the handler directly to a route and use the newly created connection directly within the handler."}),"\n",(0,o.jsx)(n.p,{children:"Example:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:'app.Get("/ws", websocket.New(func(conn *websocket.Conn, ctx *pine.Ctx) {\n// do something with the conn\n}))\n'})}),"\n",(0,o.jsx)(n.h3,{id:"conn",children:"Conn"}),"\n",(0,o.jsx)(n.p,{children:"The Conn struct is just a wrapper around the gorilla websocket conn with an added property that unlocks a neat feature on Pine out of the box."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:"type Conn struct {\n    *websocket.Conn\n    viewedBytesSize int\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"viewedBytesSize"})," property allows Pine to ship a feature known as ",(0,o.jsx)(n.code,{children:"WatchFile"}),". What ",(0,o.jsx)(n.code,{children:"WatchFile"})," does is that it is able to monitor a specific file for changes and stream the file over websockets as changes happen to the file"]}),"\n",(0,o.jsx)(n.h3,{id:"watchfile",children:"WatchFile"}),"\n",(0,o.jsxs)(n.p,{children:["As explained above, this was just a neat feature I wanted to implement having used ",(0,o.jsx)(n.a,{href:"https://fly.io",children:"fly.io"})," services for some time now. If you have used their services before, in your fly machine you have the ability to monitor live logs. This is particularly useful when you want to see what logs your server is outputing without having to ssh into your machine."]}),"\n",(0,o.jsx)(n.p,{children:"I am not sure if other cloud providers have this feature, but I wanted to build it into Pine such that you may choose to watch your log file for example in real time."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:"func (c *Conn) WatchFile(path string, conn *Conn) error\n"})}),"\n",(0,o.jsx)(n.p,{children:"This method takes in a path to a file and starts watching the file for changes and the websocket connection to write to."}),"\n",(0,o.jsx)(n.p,{children:"Currently there are some known limitations to this feature such as:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"If the file has too many changes, the OS may prevent reading the file until all writes are committed."}),"\n",(0,o.jsx)(n.li,{children:"It currently has a superficial limit of 5MB file size. I am hoping to increase this limit to improve the websocket performance."}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"There is no known limit of the number of files you can watch as each watch instance is stateless. There is no memory allocated only when a connection is opened."}),"\n",(0,o.jsx)(n.h4,{id:"example",children:"Example"}),"\n",(0,o.jsxs)(n.p,{children:["Here is how you can watch a ",(0,o.jsx)(n.code,{children:"server.log"})," file for changes."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:'app.Get("/ws", websocket.New(func(conn *websocket.Conn, ctx *pine.Ctx) {\n    websocket.WatchFile("server.log", conn)\n    logger.Info("started watching server.log")\n}))\n'})}),"\n",(0,o.jsxs)(n.p,{children:["To achieve quick monitoring of changes, I used the package ",(0,o.jsx)(n.a,{href:"https://github.com/fsnotify/fsnotify",children:"fsnotify"})," and you can check them out, perhaps you can implement a better solution on your own."]})]})}function d(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>c});var o=t(6540);const s={},i=o.createContext(s);function a(e){const n=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),o.createElement(i.Provider,{value:n},e.children)}}}]);